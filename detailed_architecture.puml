@startuml NeuroGraph-CodeRAG Architecture

!theme plain
top to bottom direction

skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 100
skinparam padding 20
skinparam arrowThickness 2
skinparam arrowColor #2C3E50

title NeuroGraph-CodeRAG: System Architecture

' ============================================
' PRESENTATION LAYER
' ============================================
package "Presentation Layer" #E8F5E9 {
    [Input Handler\n(input.py)] as Input
    [Streamlit UI\n(app.py)] as UI
    [Visualization\nEngine] as Viz
}

' ============================================
' APPLICATION LAYER
' ============================================
package "Application Layer" #E3F2FD {
    [Normal Mode\nInference Pipeline] as Normal
    [Smart Agent Mode\nReflective Agent\n(LangGraph)] as Agent
    [Prompt Builder] as Prompt
}

' ============================================
' STRUCTURAL ANALYSIS LAYER
' ============================================
package "Structural Analysis Layer" #FFF3E0 {
    [AST Analyzer] as AST
    [CFG Constructor] as CFG
    [PDG Constructor] as PDG
    [Repository Graph\nBuilder] as RepoGraph
    database "NetworkX\nCall Graph" as NXGraph
}

' ============================================
' RETRIEVAL LAYER
' ============================================
package "Retrieval Layer" #F3E5F5 {
    [RAG System] as RAG
    [CodeBERT\nEncoder] as Encoder
    database "FAISS\nIndex" as FAISS
}

' ============================================
' MODEL LAYER
' ============================================
package "Model Layer" #FCE4EC {
    [Model Loader] as Loader
    [Gemma-2b\n+ LoRA] as Model
}

' ============================================
' DATA LAYER
' ============================================
package "Data & Training Layer" #E0F2F1 {
    [Dataset Loader] as Dataset
    [Trainer] as Trainer
    [Evaluation\nMetrics] as Metrics
    database "Training\nDatasets" as TrainData
    database "Model\nCheckpoints" as Checkpoints
}

' ============================================
' PRESENTATION LAYER CONNECTIONS
' ============================================
Input -down-> UI

' ============================================
' UI TO APPLICATION LAYER
' ============================================
UI -down-> Normal : "Normal Mode"
UI -down-> Agent : "Smart Agent Mode"

' ============================================
' NORMAL MODE FLOW
' ============================================
Normal -down-> AST
Normal -down-> CFG
Normal -down-> PDG
Normal -down-> RepoGraph

AST -down-> Prompt
CFG -down-> Prompt
PDG -down-> Prompt

' ============================================
' SMART AGENT MODE FLOW
' ============================================
Agent -down-> AST
Agent -down-> CFG
Agent -down-> PDG
Agent -down-> RepoGraph

Agent -down-> Prompt

' ============================================
' REPOSITORY GRAPH
' ============================================
RepoGraph -down-> NXGraph
NXGraph -up-> Agent : "Query Dependencies"

' ============================================
' RAG INTEGRATION
' ============================================
Prompt -down-> RAG
RAG -down-> Encoder
Encoder -down-> FAISS
FAISS -up-> RAG
RAG -up-> Prompt : "Similar Examples"

' ============================================
' MODEL INFERENCE
' ============================================
Prompt -down-> Model
Model -up-> Normal : "Summary"
Model -up-> Agent : "Summary/Critique/Refinement"
Agent -down-> Model : "Iterative Refinement"

' ============================================
' MODEL INFRASTRUCTURE
' ============================================
Loader -down-> Model

' ============================================
' VISUALIZATION
' ============================================
CFG -down-> Viz
PDG -down-> Viz
NXGraph -down-> Viz
Viz -up-> UI

' ============================================
' TRAINING PIPELINE
' ============================================
TrainData -down-> Dataset
Dataset -down-> Trainer
Trainer -down-> Model : "Fine-tune"
Trainer -down-> Checkpoints
Trainer -down-> Metrics

' ============================================
' COMPONENT DETAILS
' ============================================

note right of Input
  **Processes:**
  • Code files
  • Repository paths
  • Configuration
end note

note right of Agent
  **LangGraph Workflow:**
  GENERATE → CRITIQUE →
  DECIDE → CONSULT →
  REFINE (iterate)
end note

note right of AST
  **Extracts:**
  • Function metadata
  • Parameters
  • Return types
  • Complexity
end note

note right of CFG
  **Analyzes:**
  • Control flow paths
  • Branches
  • Loops
  • Conditionals
end note

note right of PDG
  **Tracks:**
  • Data dependencies
  • Variable def-use
  • Control dependencies
end note

note right of RepoGraph
  **Provides:**
  • Cross-file calls
  • Import resolution
  • Dependency context
end note

note right of RAG
  **Features:**
  • CodeBERT embeddings
  • Top-k retrieval (k=3)
  • Few-shot learning
end note

note right of Model
  **Specifications:**
  • google/gemma-2b
  • LoRA rank: 8-16
  • Max tokens: 4096
  • Fine-tuned on 386 examples
end note

note right of Prompt
  **Combines:**
  • AST metadata
  • CFG structure
  • PDG dependencies
  • Call graph context
  • RAG examples
end note

@enduml
